<Page
    x:Class="Milki.OsuPlayer.Pages.SearchPage"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:buttonComponent="clr-namespace:Milki.OsuPlayer.UiComponents.ButtonComponent"
    xmlns:converters="clr-namespace:Milki.OsuPlayer.Converters"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:models="clr-namespace:Milki.OsuPlayer.Data.Models;assembly=OsuPlayer.Data"
    xmlns:paginationComponent="clr-namespace:Milki.OsuPlayer.UiComponents.PaginationComponent"
    xmlns:panelComponent="clr-namespace:Milki.OsuPlayer.UiComponents.PanelComponent"
    xmlns:system="clr-namespace:System;assembly=mscorlib"
    xmlns:textBoxComponent="clr-namespace:Milki.OsuPlayer.UiComponents.TextBoxComponent"
    xmlns:uiComponents="clr-namespace:Milki.OsuPlayer.UiComponents"
    xmlns:viewModels="clr-namespace:Milki.OsuPlayer.ViewModels"
    x:Name="Self"
    Title="SearchPage"
    d:DataContext="{d:DesignInstance Type=viewModels:SearchPageViewModel,
                                     IsDesignTimeCreatable=True}"
    d:DesignHeight="450"
    d:DesignWidth="800"
    Initialized="SearchPage_Initialized"
    KeepAlive="True"
    TextBlock.FontFamily="Segoe UI,微软雅黑"
    TextOptions.TextFormattingMode="Display"
    mc:Ignorable="d">
    <Page.Resources>
        <converters:TrueToVisibleConverter x:Key="TrueToVisibleConverter" />
        <system:Double x:Key="GalleryWidth">160</system:Double>
        <system:Double x:Key="GalleryHeight">220</system:Double>
        <QuinticEase x:Key="QuinticEaseOut" EasingMode="EaseOut" />
        <CircleEase x:Key="CircEaseOut" EasingMode="EaseOut" />
        <CircleEase x:Key="CircEaseIn" EasingMode="EaseIn" />
        <ContextMenu
            x:Key="DataModelListContextMenu"
            d:DataContext="{d:DesignInstance Type=models:PlayGroupQuery,
                                             IsDesignTimeCreatable=False}"
            Style="{StaticResource DefaultContextMenu}">
            <MenuItem
                Command="{Binding DataContext.PlayCommand, Mode=OneWay, Source={viewModels:RootObject}}"
                CommandParameter="{Binding}"
                Style="{StaticResource DefaultMenuItem}">
                <MenuItem.Header>
                    <TextBlock>
                        <Run Text="{DynamicResource ui-play}" /><Run Text="... (Enter)" />
                    </TextBlock>
                </MenuItem.Header>
            </MenuItem>
            <Separator />
            <MenuItem
                Command="{Binding DataContext.SearchByConditionCommand, Mode=OneWay, Source={viewModels:RootObject}}"
                CommandParameter="{Binding AutoTitle}"
                Header="{DynamicResource ui-ctxMenu-searchTitle}"
                Style="{StaticResource DefaultMenuItem}" />
            <MenuItem
                Command="{Binding DataContext.SearchByConditionCommand, Mode=OneWay, Source={viewModels:RootObject}}"
                CommandParameter="{Binding AutoArtist}"
                Header="{DynamicResource ui-ctxMenu-searchArtist}"
                Style="{StaticResource DefaultMenuItem}" />
            <MenuItem
                Command="{Binding DataContext.SearchByConditionCommand, Mode=OneWay, Source={viewModels:RootObject}}"
                CommandParameter="{Binding SongSource}"
                Header="{DynamicResource ui-ctxMenu-searchSource}"
                Style="{StaticResource DefaultMenuItem}" />
            <MenuItem
                Command="{Binding DataContext.SearchByConditionCommand, Mode=OneWay, Source={viewModels:RootObject}}"
                CommandParameter="{Binding Creator}"
                Header="{DynamicResource ui-ctxMenu-searchCreator}"
                Style="{StaticResource DefaultMenuItem}" />
            <Separator />
            <MenuItem
                Command="{Binding DataContext.OpenSourceFolderCommand, Mode=OneWay, Source={viewModels:RootObject}}"
                CommandParameter="{Binding}"
                Style="{StaticResource DefaultMenuItem}">
                <MenuItem.Header>
                    <TextBlock>
                        <Run Text="{DynamicResource ui-ctxMenu-openSourceFolder}" /><Run Text=" (Ctrl+O)" />
                    </TextBlock>
                </MenuItem.Header>
            </MenuItem>
            <MenuItem
                Command="{Binding DataContext.OpenScorePageCommand, Mode=OneWay, Source={viewModels:RootObject}}"
                CommandParameter="{Binding}"
                Header="{DynamicResource ui-ctxMenu-openScorePage}"
                Style="{StaticResource DefaultMenuItem}" />
            <Separator />
            <MenuItem
                Command="{Binding DataContext.SaveCollectionCommand, Mode=OneWay, Source={viewModels:RootObject}}"
                CommandParameter="{Binding}"
                Style="{StaticResource DefaultMenuItem}">
                <MenuItem.Header>
                    <TextBlock>
                        <Run Text="{DynamicResource ui-ctxMenu-saveTo}" /><Run Text="... (Ctrl+S)" />
                    </TextBlock>
                </MenuItem.Header>
            </MenuItem>
            <MenuItem
                Command="{Binding DataContext.ExportCommand, Mode=OneWay, Source={viewModels:RootObject}}"
                CommandParameter="{Binding}"
                Header="{DynamicResource ui-ctxMenu-export}"
                Style="{StaticResource DefaultMenuItem}" />
        </ContextMenu>
    </Page.Resources>
    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto" />
            <RowDefinition Height="Auto" />
            <RowDefinition />
            <RowDefinition Height="Auto" />
        </Grid.RowDefinitions>
        <textBoxComponent:CommonTextBox
            x:Name="SearchBox"
            Grid.Row="0"
            Width="auto"
            Height="40"
            Margin="20,20,20,15"
            Padding="3,0"
            HorizontalAlignment="Stretch"
            VerticalAlignment="Top"
            HorizontalContentAlignment="Stretch"
            VerticalContentAlignment="Center"
            FontSize="15"
            Foreground="#323232"
            Hint="{DynamicResource ui-hint-searchPageBox}" />
        <StackPanel
            Grid.Row="1"
            Margin="10,0"
            HorizontalAlignment="Right"
            Orientation="Horizontal">
            <buttonComponent:CommonButton
                x:Name="BtnPlayAll"
                Click="BtnPlayAll_Click"
                Style="{StaticResource PlayButton}" />
            <buttonComponent:CommonButton
                x:Name="BtnQueueAll"
                Click="BtnQueueAll_Click"
                Command="{Binding ItemFolderCommand}"
                CommandParameter="{Binding ExportPath}"
                Content="{DynamicResource ui-btn-queueAll}"
                IconTemplate="{StaticResource FolderTempl}"
                Style="{StaticResource SettingsButton}" />
        </StackPanel>
        <ListBox
            x:Name="ResultCardList"
            Grid.Row="2"
            Padding="3,0"
            Background="Transparent"
            BorderThickness="0"
            ItemContainerStyle="{StaticResource CardListBoxItemStyle}"
            ItemsSource="{Binding PlayItems, Mode=OneWay}">
            <ListBox.ItemTemplate>
                <DataTemplate DataType="{x:Type models:PlayGroupQuery}">
                    <Grid
                        x:Name="mainGrid"
                        ContextMenu="{StaticResource DataModelListContextMenu}"
                        RenderTransformOrigin="0.5,0.5"
                        ToolTip="{StaticResource DataModelListToolTip}">
                        <Border
                            Background="#FBFBFB"
                            BorderBrush="#20646464"
                            BorderThickness="1">
                            <Grid Margin="5">
                                <Grid.RowDefinitions>
                                    <RowDefinition />
                                    <RowDefinition Height="auto" />
                                    <RowDefinition Height="auto" />
                                </Grid.RowDefinitions>

                                <Button
                                    Margin="0,0,0,5"
                                    Padding="0" Click="BtnPlayDefault_OnClick"
                                    Cursor="Hand"
                                    Tag="{Binding}">
                                    <!--<Button.Command>
                                        <Binding Path="DataContext.DirectPlayCommand" Mode="OneWay" ElementName="Self" />
                                    </Button.Command>-->
                                    <Button.Template>
                                        <ControlTemplate TargetType="Button">
                                            <Grid Background="#F0F0F0">
                                                <Image
                                                    HorizontalAlignment="Center"
                                                    VerticalAlignment="Center"
                                                    RenderOptions.BitmapScalingMode="LowQuality"
                                                    Source="{Binding PlayItem.PlayItemAsset.FullThumbPath}"
                                                    Stretch="UniformToFill" />
                                                <Border
                                                    x:Name="CoverBorder"
                                                    Background="#50000000"
                                                    Opacity="0">
                                                    <Viewbox Width="48" Height="48">
                                                        <Viewbox.Effect>
                                                            <DropShadowEffect
                                                                BlurRadius="15"
                                                                Opacity="0.4"
                                                                ShadowDepth="0" />
                                                        </Viewbox.Effect>
                                                        <ContentControl Foreground="#E0FFFFFF" Template="{StaticResource PlayTempl}" />
                                                    </Viewbox>
                                                </Border>
                                            </Grid>
                                            <ControlTemplate.Triggers>
                                                <Trigger Property="IsMouseOver" Value="True">
                                                    <Trigger.EnterActions>
                                                        <BeginStoryboard>
                                                            <Storyboard Storyboard.TargetName="CoverBorder">
                                                                <DoubleAnimation
                                                                    EasingFunction="{StaticResource CircEaseOut}"
                                                                    Storyboard.TargetProperty="Opacity"
                                                                    To="1"
                                                                    Duration="0:0:0.2" />
                                                            </Storyboard>
                                                        </BeginStoryboard>
                                                    </Trigger.EnterActions>
                                                    <Trigger.ExitActions>
                                                        <BeginStoryboard>
                                                            <Storyboard Storyboard.TargetName="CoverBorder">
                                                                <DoubleAnimation
                                                                    EasingFunction="{StaticResource QuinticEaseOut}"
                                                                    Storyboard.TargetProperty="Opacity"
                                                                    To="0"
                                                                    Duration="0:0:0.3" />
                                                            </Storyboard>
                                                        </BeginStoryboard>
                                                    </Trigger.ExitActions>
                                                </Trigger>
                                            </ControlTemplate.Triggers>
                                        </ControlTemplate>
                                    </Button.Template>
                                </Button>

                                <TextBlock
                                    Grid.Row="1"
                                    Margin="0,0,0,5"
                                    Text="{Binding ArtistAuto}" />
                                <TextBlock Grid.Row="2" Text="{Binding TitleAuto}" />
                            </Grid>
                        </Border>
                    </Grid>
                </DataTemplate>
            </ListBox.ItemTemplate>

            <ListBox.ItemsPanel>
                <ItemsPanelTemplate>
                    <panelComponent:VirtualizingGalleryWrapPanel
                        ChildHeight="{StaticResource GalleryHeight}"
                        ChildWidth="{StaticResource GalleryWidth}"
                        ItemLoaded="VirtualizingGalleryWrapPanel_OnItemLoaded"
                        ScrollOffset="100" />
                </ItemsPanelTemplate>
            </ListBox.ItemsPanel>

        </ListBox>
        <paginationComponent:Pagination
            x:Name="Pagination"
            Grid.Row="3"
            Margin="10"
            HorizontalAlignment="Center"
            ItemsCount="20"
            PageSelected="Pagination_OnPageSelected" />
    </Grid>
</Page>
